# Shellpea_CDEK модуль

<font color='green'>**Модуль интеграции со службой доставки СДЭК для Magento 2.4.6 и выше.** </font>
________________
# Возможности модуля
* доставка посылок по России транспортной компанией СДЭК
* реализованы тарифы Посылка и Экономичная посылка
* расчет стоимости доставки
    * в пвз
    * в постамат
    * курьером
* возможность выбора ПВЗ при оформлении заказа с тарифом до склада
* возможность выбора постамата при оформлении заказа с тарифом до постамата
* создание заказы в информационной системе СДЭК
* генерация печатной формы ШК-мест
* отслеживание заказа
* возможность выбора способа доставки посылок до транспортной компанией СДЭК
  * самостоятельно в ПВЗ
  * через курьера
________________
# Настройка модуля
## Шаг 1. Заключение договора со СДЭК.
Для работы с модулем требуется наличие договора со службой доставки СДЭК.  
Если у Вас еще его нет, Вы можете заключить его [тут](https://www.cdek.ru/ru/B2C-B2B-FORM/).  
## Шаг 2. Установите модуль СДЭК
```
composer require shellpea/magento-cdek-shipping
```
## Шаг 3. Включить СДЭК для вашего магазина.
1. Перейдите в панель администратора в раздел  
`Stores > Settings > Configuration > Sales > Delivery Methods > CDEK`    

 
2. Установите значение поля **Enabled** на **Yes**.

 
3. В поле **Title** введите название метода доставки, которое будет отображаться пользователям во время оформления заказа.

 
4. Заполните поля **Account** и **Secure Password**, которые соответствуют **Идентификатору** и **Паролю** клиента из [личного кабинете СДЭК](https://lk.cdek.ru/integration) в разделе “Интеграция”.  

5. *Опционально В модуле имеется интеграция с Yandex Maps, для включения небходимо заполнить оба поля **Enabled Map for Checkout** и **Yandex Api Key** ключ можно получить на [API Яндекс Карты](https://yandex.ru/maps-api)*
 
6. Установите значение поля **Test Mode** на **No**.  
Если Вы хотите протестировать доставку на тестовой среде CDEK, то необходимо установить **Test Mode** на **Yes** и ввести ключи от тестовой учётной записи.  
Данные для тестовой учётной записи являются общими и указаны в [документации](https://api-docs.cdek.ru/29923849.html).

 
7. В поле **How the parcel will be delivered to Cdek?** необходимо выбрать способ доставки посылок до СДЭК:
   * **I will bring the parcel to Cdek myself** - Вы самостоятельно доставляете посылку до офиса СДЭК.
   * **The courier must pick up the parcel** - курьер должен забрать посылку и доставить в СДЭК.  
   _Данное поле отвечает за выбор способа доставки (от двери/со склада), который влияет на стоимость доставки._

 
8. В поле **ZIP/Postal Code** укажите почтовый индекс города отправления.

 
9. **Адрес отправления** устанавливается одним из следующих способов:  
    * При **How the parcel will be delivered to Cdek?** равном **I will bring the parcel to Cdek myself**  
    доступно поле **Pickup Point**, в нем на основе почтового индекса из **ZIP/Postal Code** отображется список офисов.  
   Выберите подходящий Вам офис, от него будет производиться расчет стоимсоти доставки.  
   _(В выбранный офис Вами производиться самостоятельный привоз посылки.)_
    * При **How the parcel will be delivered to Cdek?** равном **The courier must pick up the parcel**  
   необходимо указать адрес, на который должен прийти курьер, для этого заполните следующие поля:
      * Region/State
      * City
      * Street Address
      * Street Address Line 2 _(необязательно)_

 
10. В поле **Delivery mode** выберите способы доставки, доступные пользователям при оформлении заказа:
    * Delivery by courier _(Доставка курьером)_
    * Delivery to the pick-up point _(Доствка в ПВЗ)_
    * Delivery to the parcel terminal _(Доставка в постамат)_

 
11. Чтобы в Magento приходили вебхуки необходимо установить **Webhooks Enable** на **Yes** и **Test Mode** на **No**.  
    Убедитесь, что в **Account** и **Secure Password** заполнены корректные данные из [личного кабинете СДЭК](https://lk.cdek.ru/integration)  
    _(В тсетовом режиме Webhooks не приходят.)_

 
12. **Quantity of copies of the Shipping label** - число копий печатной формы.

 
13. **Barcode Format** - Формат печати. Может принимать значения: A4, A5, A6, A7.

 
14. Установите габариты упаковки: _(влияет на стоимость доставки)_
    * Выберете коробку из списка в поле **Packaging**  
    При **Packaging** равном **Your Packaging** установите значения для следующих полей:  
        * **Package Length (cm)**
        * **Package Width (cm)**
        * **Package Height (cm)**  
      _(Значение в сантиметрах)_
    * В **Default Attribute Set** добавлены следующие атрибуты:
        * **Package Length For Cdek (cm)**
        * **Package Width For Cdek (cm)**
        * **Package Height For Cdek (cm)**  
      _(Значение в сантиметрах)_  
    ***Если у продукта указаны значения этих атрибутов, они будут использоваться для расчета стоимости доставки,  
    в противном случае - габариты для выбранного Package в поле Packaging***.

 
15. В поле **Sort Order** введите число, чтобы определить последовательность, в которой СДЭК будет отображаться среди других способов доставки во время оформления заказа.

 
16. Нажмите **Save Config**.
________________
## Регистрация Заказа в СДЭК

1. На боковой панели администратора откроте вкладку `Sales > Orders`,  
 найдите нужный заказ и перейдите на страницу Order View.


2. Для уже существющего Shipment:
   * Откройте вкладку *Shipments*, перейдите на страницу нужного Shipment  
   и в секции **Shipping and Tracking Information** нажмите на **Create Shipping Label**.  

   При создании нового Shipment:
    * Нажмите на кнопку **Ship**. В появившемся окне необходимо выбрать опцию **Create Shipping Label**.  
     После чего нажмите на кнопку **Submit Shipment…**.


3. Распределите товары по упаковкам, укажите для них вес и габариты, нажмите Save.  
_(Обратите внимание, что у каждого Package есть единицы измерения веса (kg/lb) и единица измерения габаритов(cm/in).  
 Значение на СДЭК отпрвлятся в kg и cm соответственно.   
Поэтому если у Package единицой измерения веса являются lb, знаенчие веса будет конвертировано в kg.  
Аналогично и габариты из in будут конвертированы в cm)_


4. При успешном создании Shipping Label в секции *Shipping and Tracking Information* появится кнопка `Print Shipping Label`  
 и номер для отслеживания, по которому можно отследить заказ в СДЭК.  
_(Если при созднии Shipping Label возникнет какая-либо проблема, в форме Create Shipping Label появится сообщение об ошибки.)_


5. Чтобы скачать печатную форму ШК нажмите `Print Shipping Label`
